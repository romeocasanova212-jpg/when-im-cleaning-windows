# Unity IAP Setup Guide

**Project**: When I'm Cleaning Windows  
**Purpose**: Production-ready Unity IAP integration for real purchases

---

## üõí Quick Setup (Production)

### Step 1: Install Unity IAP Package

1. Open Unity 6.3 LTS
2. **Window ‚Üí Package Manager**
3. Search: **"In-App Purchasing"**
4. Click **Install**
5. Wait for compilation

### Step 2: Configure Google Play Console

1. Go to [Google Play Console](https://play.google.com/console)
2. Create app or select existing
3. **Monetization ‚Üí Products ‚Üí In-app products**
4. Create 28 products matching these IDs:

#### Starter Bundles
- `com.cleaningwindows.welcomepack` - $0.99
- `com.cleaningwindows.rookiebundle` - $2.99
- `com.cleaningwindows.progressionpack` - $4.99

#### Gem Packs
- `com.cleaningwindows.gempouch` - $1.99
- `com.cleaningwindows.gembag` - $4.99
- `com.cleaningwindows.gempile` - $9.99
- `com.cleaningwindows.gemchest` - $19.99
- `com.cleaningwindows.gemvault` - $49.99
- `com.cleaningwindows.gemtreasure` - $99.99
- `com.cleaningwindows.gemfortune` - $199.99 (whale tier)
- `com.cleaningwindows.gemmountain` - $299.99 (ultra whale)

#### VIP Subscriptions
- `com.cleaningwindows.vipbronze` - $4.99/month (auto-renewing)
- `com.cleaningwindows.vipsilver` - $9.99/month (auto-renewing)
- `com.cleaningwindows.vipgold` - $19.99/month (auto-renewing)

#### Power-Ups
- `com.cleaningwindows.powerupnuke` - $0.99
- `com.cleaningwindows.powerupturbo` - $0.99
- `com.cleaningwindows.powerupautopilot` - $1.99
- `com.cleaningwindows.poweruptimefreeze` - $1.99

#### Energy Refills
- `com.cleaningwindows.energyrefill5` - $0.99
- `com.cleaningwindows.energyrefill10` - $1.99

#### Cosmetics (Phase 3)
- `com.cleaningwindows.squeegee_classic` - $2.99 (non-consumable)
- `com.cleaningwindows.squeegee_gold` - $4.99 (non-consumable)
- `com.cleaningwindows.theme_urban` - $1.99 (non-consumable)
- `com.cleaningwindows.theme_nature` - $1.99 (non-consumable)
- `com.cleaningwindows.particle_stars` - $0.99 (non-consumable)
- `com.cleaningwindows.particle_rainbow` - $0.99 (non-consumable)

#### Skips
- `com.cleaningwindows.skiptimer` - $0.99
- `com.cleaningwindows.skiplevel` - $1.99

5. Copy **Google Play License Key** (for receipt validation)

### Step 3: Configure App Store Connect (iOS)

1. Go to [App Store Connect](https://appstoreconnect.apple.com)
2. Select your app
3. **Features ‚Üí In-App Purchases**
4. Create same 28 products (match Android IDs without "com.cleaningwindows" prefix)
5. Set pricing tiers to match Android USD prices
6. Submit for review

### Step 4: Configure Unity IAP

1. **Window ‚Üí Unity IAP ‚Üí IAP Catalog**
2. Import all 28 products:
   - Click **Add Product**
   - Enter Product ID (e.g., `com.cleaningwindows.welcomepack`)
   - Select Type:
     * **Consumable**: Gem packs, bundles, power-ups, refills, skips
     * **Subscription**: VIP tiers
     * **Non-Consumable**: Cosmetics
   - Repeat for all 28 products

3. **Services ‚Üí In-App Purchasing**
   - Click **Enable**
   - Link Google Play and App Store accounts

### Step 5: Receipt Validation Setup

1. **Window ‚Üí Unity IAP ‚Üí Receipt Validation Obfuscator**
2. Paste **Google Play License Key**
3. Paste **Apple Shared Secret** (from App Store Connect)
4. Click **Obfuscate Google Play License Key**
5. Click **Obfuscate Apple Shared Secret**
6. This generates `GooglePlayTangle.cs` and `AppleTangle.cs`
7. Replace placeholder code in [UnityIAPIntegration.cs](../Assets/Scripts/Monetization/UnityIAPIntegration.cs#L644)

### Step 6: Integrate with Bootstrapper

Add UnityIAPIntegration to initialization:

```csharp
// In Bootstrapper.cs, Phase 2
private void InitializeUnityIAP()
{
    if (UnityIAPIntegration.Instance == null)
    {
        GameObject obj = new GameObject("UnityIAPIntegration");
        obj.AddComponent<UnityIAPIntegration>();
    }
    
    if (showDebugLogs) Debug.Log("‚úì UnityIAPIntegration initialized");
}
```

### Step 7: Test Purchases

#### Sandbox Testing (Android)
1. Add test account in Google Play Console
2. **Settings ‚Üí License Testing**
3. Add email addresses
4. Build APK/AAB and upload to Internal Testing track
5. Download on device with test account
6. Purchases are free but trigger real purchase flow

#### Sandbox Testing (iOS)
1. Create sandbox tester in App Store Connect
2. **Users and Access ‚Üí Sandbox Testers**
3. Build to TestFlight or Xcode
4. Sign out of App Store on device
5. Launch app - sign in with sandbox account when prompted
6. Purchases are free but trigger real purchase flow

---

## üîß Production Build Configuration

### Android (Google Play)

**build.gradle** (auto-generated by Unity):
```gradle
dependencies {
    implementation 'com.android.billingclient:billing:5.0.0'
}
```

**AndroidManifest.xml**:
```xml
<uses-permission android:name="com.android.vending.BILLING" />
```

Unity handles this automatically when IAP package is installed.

### iOS (App Store)

**Capabilities**:
1. Select iOS build target
2. **Player Settings ‚Üí Publishing Settings**
3. Check **"In-App Purchase"** capability
4. Unity generates StoreKit configuration automatically

---

## üìä Analytics Integration

All purchases automatically log to Firebase:

```csharp
FirebaseManager.Instance?.LogPurchase(
    productId,
    productType,
    price,
    currencyCode
);
```

Tracked metrics:
- Purchase event with product details
- Revenue per user
- Conversion rates
- Subscription renewal rates

---

## üß™ Debug Testing (No Store Setup)

For development without store accounts:

```csharp
// In UnityIAPIntegration Inspector
Debug Mode: ‚úì (checked)
Enable IAP: ‚úì (checked)
Validate Receipts: ‚úó (unchecked for debug)
```

This allows testing purchase flow logic without real store connections.

---

## üîê Receipt Validation

Production mode validates all receipts:

1. **Google Play**: RSA signature verification
2. **Apple**: Receipt validation via StoreKit
3. **Server-side** (recommended for production):
   - Send receipt to your backend
   - Backend calls Google/Apple APIs
   - Returns validation result
   - Prevents client-side tampering

Current implementation uses Unity's built-in validation (sufficient for launch).

---

## üí∞ Price Localization

Unity IAP automatically handles:
- Currency conversion (USD ‚Üí EUR, JPY, etc.)
- Regional pricing tiers
- Tax calculations per country
- Price display in user's local currency

Access localized price:
```csharp
string price = UnityIAPIntegration.Instance.GetLocalizedPrice("com.cleaningwindows.welcomepack");
// Returns: "$0.99" (US), "0,99 ‚Ç¨" (EU), "¬•120" (JP)
```

---

## üîÑ Subscription Management

Check subscription status:
```csharp
bool isVIP = UnityIAPIntegration.Instance.IsSubscribed("com.cleaningwindows.vipgold");
DateTime expiry = UnityIAPIntegration.Instance.GetSubscriptionExpiry("com.cleaningwindows.vipgold");
```

Auto-renewal handled by:
- **Android**: Google Play Billing Library
- **iOS**: StoreKit with App Store

---

## üì± Restore Purchases (iOS Required)

iOS requires "Restore Purchases" button:

```csharp
public void OnRestorePurchasesButton()
{
    UnityIAPIntegration.Instance.RestorePurchases();
}
```

Add to Settings screen for iOS builds.

---

## üêõ Common Issues

### "Product unavailable"
**Solution**: Product not configured in Google Play Console or App Store Connect. Verify all 28 SKUs exist.

### "Receipt validation failed"
**Solution**: 
1. Check GooglePlayTangle and AppleTangle are generated
2. Verify license keys are current
3. Disable validation for sandbox testing

### "Store not initialized"
**Solution**: Unity IAP package not installed or services not enabled. Check **Services ‚Üí In-App Purchasing**.

### "Purchase already owned" (Android)
**Solution**: Consumable products must be consumed after purchase. Current implementation auto-consumes.

### Subscription not renewing
**Solution**: 
1. Sandbox subscriptions renew every 5 minutes (not monthly)
2. Check subscription expiry in store console
3. Verify auto-renewal is enabled

---

## üìà Revenue Optimization Tips

**Welcome Pack ($0.99)**:
- 50% discount shown in PersonalizationEngine D1 offer
- Highest conversion rate (target: 15-20% D1 payers)

**Gem Packs**:
- "Best Value" badge on $19.99 tier (20% bonus)
- Whale tiers ($199.99, $299.99) for top 0.1% spenders

**VIP Subscriptions**:
- Trial period: 3 days free (configure in store)
- Grace period: 3 days after expiry (retain subscription)
- Upgrade path: Bronze ‚Üí Silver ‚Üí Gold

**Dynamic Pricing**:
- Use RemoteConfigManager to adjust prices without app update
- A/B test: $0.99 vs $1.99 Welcome Pack
- Seasonal events: Holiday bundles with 100% bonus

---

## ‚úÖ Production Checklist

Before submitting to stores:

- [ ] All 28 products configured in Google Play Console
- [ ] All 28 products configured in App Store Connect
- [ ] Receipt validation enabled and tested
- [ ] License keys obfuscated (GooglePlayTangle/AppleTangle)
- [ ] Sandbox testing completed on Android and iOS
- [ ] "Restore Purchases" button added (iOS requirement)
- [ ] Privacy policy includes IAP information
- [ ] Terms of service mention subscriptions and auto-renewal
- [ ] Analytics tracking purchases to Firebase
- [ ] Refund policy documented
- [ ] Customer support email configured

---

## üöÄ Go Live

1. Upload signed APK/AAB to Google Play (Production track)
2. Submit app to App Store (for review)
3. Monitor analytics dashboard for first purchases
4. Watch Crashlytics for IAP-related errors
5. Set up alerts for payment failures

**Estimated Setup Time**: 2-4 hours (first time), 30 minutes (subsequent updates)

---

*For integration details, see: [UnityIAPIntegration.cs](../Assets/Scripts/Monetization/UnityIAPIntegration.cs)*
